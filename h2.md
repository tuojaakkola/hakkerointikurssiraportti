# h2 Break & Unbreak.md

## x)

### OWASP 10
Broken access control: Käyttäjän pääsynhallinnan valvomisen epäonnistuminen. Eli käyttäjät voivat suorittaa toimintoja, jotka ovat heidän käyttäjäoikeuksiensa ulkopuolella. Tämä oli yleisin tietoturvavirhe 2021 OWASP Top 10-listassa.

### Karvinen 2023: Find Hidden Web Directories - Fuzz URLs with ffuf
ffuf on fuzzer, jolla voi automatisoida haavoittuvuuksien etsimisen web-sovelluksista. ffuf avulla voit valita kohteen ja syöttää sille sanalistan, jonka jälkeen se lähettää tuhansia pyyntöjä sivulle sekunneissa testaten kaikkia mahdollisia komboja sanalistasta esimerkiksi urliin.  

Pyyntöjen jälkeen se kertoo eri pyyntöjen vastaukset joita voit tutkia ja tulkita. 

### PortSwigger: Access control vulnerabilities and privilege escalation
Verkkosovellusten kontekstissa pääsynhallinta on riippuvainen tunnistautumisesta ja istunnonhallinnasta. Se määrittää onko käyttäjän sallittua suorittaa toiminto, jota hän yrittää tehdä.  

Tapoja estää pääsynhallinan haavoittuvuudete:  
Jos resurssin ei ole tarkoitus olla julkisesti saatavilla, kiellä pääsy oletuksena (deny by default).  
Käytä aina yhtä sovelluksen laajuista mekanismia pääsynhallinnan valvontaan jos mahdollista.  
Tee kooditasolla pakolliseksi, että kehittäjät määrittelevät kullekin resurssille sallitun pääsyn ja kiellä pääsy oletuksena.

## Ympäristö
Tein tehtävän samsungin kannettavalla tietokoneellani ja siihen asennettelulla Oraclen Virtualbox ohjelmalla, jossa minulla pyöri Linux Ubuntu. Tein harjoituksen lauantaina 24.1.2026 

## a)
Tehtäväni alustus sujui hyvin ja asensin tarvittavat paketit tehtävänannon  mukaisesti, jotta ensimmäisen tehtävän sivun sai auki.  

Testasin pin coodin kenttään 'OR 1=1;-- Tästä tuli kuitenkin vain ilmoitus "Kirjoita luku.". Muutin input elementtiä muotoon type=text jolloin 'OR 1=1;-- antoi salasanan foo. Tämä on jonkun toisen salasana mutta ei adminin.  

Nyt tiedätään siis että sovelluksessa on haavoittuvuus, joka mahdollistaa sql-injektion. Aloin selvittämään miten voin etsiä vihjeen SUPERADMIN avulla salasanan. Löysin sql LIKE komennon joka sopii juuri tälläisiin tilanteisiin, jossa tiedetään osa salasanasta.  

LIKE komennolla % merkkien kanssa voin etsiä mitä tahansa tekstiä tietokannasta. Laittamalla kenttään lause ' OR password LIKE '%SUPERADMIN%' saatiin sivulta palautettua haluttu salasasana SUPERADMIN%%rootALL-FLAG{Tero-e45f8764675e4463db969473b6d0fcdd} .

Käytetty hyökkäysmerkkijono oli:  
' OR password LIKE '%SUPERADMIN%

Hyökkäys toimii seuraavasti:
- ' merkki sulkee alkuperäisen koodin PIN-kentän määrittelyn tyhjäksi, jotta voimme lisätä oman ehtomme.
- OR: Kertoo tietokannalle, että rivi hyväksytään, jos jompikumpi ehto on tosi.
- password LIKE: Kohdistaa haun password-sarakkeeseen ja käyttää LIKE-operaattoria, joka mahdollistaa osittaiset osumat.
- '%SUPERADMIN%': Itse hakutermi. Prosenttimerkit % toimivat jokerimerkkeinä. Lauseke tarkoittaa: "Hyväksy salasana, jonka sisällä on teksti SUPERADMIN, riippumatta siitä mitä merkkejä on ennen sitä tai sen jälkeen."

## b)
Haavoittuvuus oli koodirivissä sql = "SELECT password FROM pins WHERE pin='"+pin+"';", jossa määritetään kysely sekä rivissä myöhemmässä rivissä jossa kysely oikeasti suoritetaan tietokantaan.  
Ensimmäinen rivi liimaa käyttäjän syötteen suoraan SQL kyselyyn ja mahdollistaa injektion.  

Korjaus tehtiin muuttamalla lauseen loppu. Uusi lause: sql = "SELECT password FROM pins WHERE pin=:id" sekä muokkaamalla myös myöhempää tietokantakyselyn suorittamislausetta uuden ratkaisun mukaiseksi. Korjauksessa haavoittuva merkkijonojen yhdistäminen korvattiin parametrisoidulla kyselyllä. SQL-lauseeseen asetettiin paikanpitäjä :id, ja käyttäjän syöttämä data välitetään tietokannalle erillisenä parametrina. Tämä estää tietokantaa tulkitsemasta käyttäjän syötettä SQL-komentona.

<img width="839" height="545" alt="kuva" src="https://github.com/user-attachments/assets/2255de2b-d337-471a-91f1-52d880d2776c" />

Korjauksen jälkeen syöte, jolla aiemmin saatiin salasana ei enää anna salasanaa.

## c)
Tein ohjeen mukaan dirfuzt-0 tehtävän, jonka jälkeen siirryin dirfuzt 1 tehtävään. Suoritin ensin fuzzin ilman filtterreitä ja huomasin että melkein kaikki vastauksista oli kooltaan 154. Tein harjoitustehtävästä oppineena uuden fuzzin filtterillä -fs 154. Tämä poistaa vastauksista ne joiden koko (size in bytes) on tuo 154.  

Tällöin sain vain 7 vastausta, joita tutkimalla sain selville että adminin sivu löytyy polusta wp-admin FLAG{tero-wpadmin-3364c855a2ac87341fc7bcbda955b580}. Versionhallintaan liittyvät sivut löytyivät polusta .git FLAG{tero-git-3cc87212bcd411686a3b9e547d47fc51}. 

## d)
Tehtävässä kokeilin ohittaa salasanan veikkaamalla username kohtaan: administrator' OR 1=1;-- jotta voisin ohittaa salasanan. Tämä ei kuitenkaan mennyt läpi. Koitin fuzzata osoitetta http://127.0.0.1:8000/FUZZ commont.txt sanalistan avulla, jossa 020 tehtävä oli ajossa.  

Tästä huomasin yhden vastauksen admin-console polussa. Tämä osoite vaati kuitenkin myös kirjautumista, joten kokeilin myös tänne sql inejktiota ' OR 1=1 -- sekä admin' OR 1=1 --   lauseilla. Tämä ei myöskään ohittanut kirjautumista.  

Katsoin vihjeitä ja loin oman käyttäjän. En ollut tehnyt luonut sitä vaan olin vain yrittänyt sql injektiota eri tavoilla. Löytämäni osoite admin-console avasi kirjautumisen jälkeen halutun salaisen sivun.

## e)
Vinkkien avulla löysin, että haavoittuvuus löytyy tiedostosta views.py. Siellä on määritetty eri näkymien turvatarkastuksia. Tiedostossa oli määritetty, että AdminShowAllView luokkaan pääsee sisään jos on kirjautunut.  

Tämä mahdollisti normaalin käyttäjän pääsyn adminin consoleen jos vain löytsi oikean polun admin-console/. Haavoittuvuus korjattiin muokkaamlla tarkistus samanlaiseksi kuin AdminDashboardissa:  

def test_func(self):
		return self.request.user.is_authenticated and self.request.user.is_staff

Tämä tarkistaa että käyttäjä on kirjautunut ja että hänen on staff, jotta hän voi päästä tuolle adminin console sivulle.

<img width="927" height="468" alt="kuva" src="https://github.com/user-attachments/assets/cfebfa56-fdf5-42b8-be35-61ad6915ee75" />
<img width="927" height="177" alt="kuva" src="https://github.com/user-attachments/assets/2c9218e1-8e37-4021-85e1-234e89b0bdcf" />

Korjauksen jälkeen polku ei enään toiminut vaan näytti 403 Forbidden virheen. Kyseessä oli siis sivun puutteellinen pääsynhallinta.

Lähteet:
https://www.w3schools.com/sql/sql_like.asp  
Google Gemini 3 Pro sparraamiseen, asioiden opettamiseen.
